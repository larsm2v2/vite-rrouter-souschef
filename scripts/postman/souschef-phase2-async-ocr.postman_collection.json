{
  "info": {
    "_postman_id": "async-ocr-phase2-2025",
    "name": "SousChef - Phase 2 Async OCR",
    "description": "Tests for Phase 2 async OCR processing with Pub/Sub",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Authentication",
      "item": [
        {
          "name": "Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const jsonData = pm.response.json();",
                  "    if (jsonData.accessToken) {",
                  "        const token = jsonData.accessToken.trim();",
                  "        pm.collectionVariables.set('accessToken', token);",
                  "        console.log('Access token saved:', token.substring(0, 20) + '...');",
                  "    } else {",
                  "        console.error('No accessToken in response:', jsonData);",
                  "    }",
                  "} else {",
                  "    console.error('Login failed with status:', pm.response.code);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"email\": \"{{testEmail}}\",\n    \"password\": \"{{testPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/auth/login",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "login"]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "OCR - Async Flow",
      "item": [
        {
          "name": "Upload Image (Async)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has jobId', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('jobId');",
                  "    pm.expect(jsonData).to.have.property('status');",
                  "    pm.expect(jsonData).to.have.property('statusUrl');",
                  "    ",
                  "    // Save jobId for status polling",
                  "    pm.collectionVariables.set('currentJobId', jsonData.jobId);",
                  "    console.log('Job created:', jsonData.jobId);",
                  "});",
                  "",
                  "pm.test('Status is pending', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.equal('pending');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "image",
                  "type": "file",
                  "src": []
                }
              ]
            },
            "url": {
              "raw": "{{baseUrl}}/api/ocr/upload",
              "host": ["{{baseUrl}}"],
              "path": ["api", "ocr", "upload"]
            },
            "description": "Upload an image for async OCR processing. Returns jobId immediately."
          },
          "response": []
        },
        {
          "name": "Check Job Status",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Guard: verify currentJobId is present before relying on response",
                  "(function checkPathVar() {",
                  "    const jobIdVar = pm.variables.get('currentJobId');",
                  "    const jobIdInUrl = (pm.request && pm.request.url && pm.request.url.toString()) || '';",
                  "    pm.test(\"Pre-check: currentJobId is set and present in request URL\", function () {",
                  "        pm.expect(jobIdVar, \"Environment/collection variable 'currentJobId' must be set\").to.be.a('string').and.not.empty;",
                  "        pm.expect(jobIdInUrl, \"Request URL should include the jobId path variable\").to.include(String(jobIdVar));",
                  "    });",
                  "})();",
                  "",
                  "// Helpers",
                  "function isJsonContentType() {",
                  "    const ct = pm.response.headers.get('Content-Type') || '';",
                  "    return /application\\/json|\\+json/i.test(ct);",
                  "}",
                  "",
                  "function safeGetBodyText() {",
                  "    try { return pm.response.text(); } catch (e) { return ''; }",
                  "}",
                  "",
                  "// Main branching based on Content-Type and status",
                  "let parsedJson = null;",
                  "let parseError = null;",
                  "const statusCode = pm.response.code;",
                  "const bodyText = safeGetBodyText();",
                  "const contentTypeIsJson = isJsonContentType();",
                  "",
                  "// Special handling for 404 with HTML/text body (likely missing jobId or wrong URL)",
                  "if (statusCode === 404 && !contentTypeIsJson) {",
                  "    pm.test(\"Informational: 404 Not Found - likely missing or invalid currentJobId\", function () {",
                  "        pm.expect(statusCode).to.eql(404);",
                  "    });",
                  "",
                  "    pm.test(\"Hint: Check baseUrl and currentJobId in the request path\", function () {",
                  "        const baseUrl = pm.variables.get('baseUrl');",
                  "        const currentJobId = pm.variables.get('currentJobId');",
                  "        const exampleSnippet = (bodyText || '').slice(0, 120);",
                  "        pm.expect(true, \"Server responded 404. This often happens if currentJobId is empty or the job does not exist.\\n\" +",
                  "            \"- baseUrl: \" + baseUrl + \"\\n\" +",
                  "            \"- currentJobId: \" + currentJobId + \"\\n\" +",
                  "            \"- First 120 chars of response: \" + exampleSnippet).to.be.true;",
                  "    });",
                  "} else {",
                  "    // Try JSON parse when content-type indicates JSON or as best effort",
                  "    if (contentTypeIsJson) {",
                  "        try {",
                  "            parsedJson = pm.response.json();",
                  "        } catch (e) {",
                  "            parseError = e;",
                  "        }",
                  "    } else {",
                  "        // Body not JSON content-type, attempt parse only if it looks like JSON",
                  "        if (/^\\s*[{\\[]/.test(bodyText)) {",
                  "            try { parsedJson = pm.response.json(); } catch (e) { parseError = e; }",
                  "        }",
                  "    }",
                  "",
                  "    if (parseError) {",
                  "        // Set lastErrorBody with raw text and surface an explanatory test",
                  "        pm.environment.set('lastErrorBody', bodyText || '');",
                  "        pm.test(\"Parsing failed: response is not valid JSON\", function () {",
                  "            const preview = (bodyText || '').slice(0, 120);",
                  "            pm.expect(true, \"Could not parse JSON. Stored raw body in environment var 'lastErrorBody'. Preview: \" + preview).to.be.true;",
                  "        });",
                  "    }",
                  "",
                  "    if (parsedJson) {",
                  "        // Original tests preserved for backwards compatibility",
                  "        pm.test('Status code is 200', function () {",
                  "            pm.response.to.have.status(200);",
                  "        });",
                  "",
                  "        pm.test('Response has job data', function () {",
                  "            pm.expect(parsedJson).to.have.property('jobId');",
                  "            pm.expect(parsedJson).to.have.property('status');",
                  "            pm.expect(parsedJson).to.have.property('createdAt');",
                  "            pm.expect(parsedJson).to.have.property('updatedAt');",
                  "        });",
                  "",
                  "        // Safe logs only after successful parse",
                  "        console.log('Job status:', parsedJson.status);",
                  "",
                  "        if (parsedJson.status === 'completed') {",
                  "            pm.test('Completed job has result', function () {",
                  "                pm.expect(parsedJson).to.have.property('result');",
                  "                pm.expect(parsedJson).to.have.property('ocrText');",
                  "                pm.expect(parsedJson).to.have.property('processingTimeMs');",
                  "            });",
                  "            console.log('Processing time:', parsedJson.processingTimeMs, 'ms');",
                  "        }",
                  "",
                  "        if (parsedJson.status === 'failed') {",
                  "            pm.test('Failed job has error', function () {",
                  "                pm.expect(parsedJson).to.have.property('error');",
                  "            });",
                  "            console.log('Job failed with error:', parsedJson.error);",
                  "        }",
                  "    } else if (!parseError) {",
                  "        // Non-JSON successful cases or other statuses without parse error",
                  "        pm.test(\"Response is not JSON; skipping JSON-specific tests\", function () {",
                  "            pm.expect(true).to.be.true;",
                  "        });",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/ocr/status/{{currentJobId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "ocr", "status", "{{currentJobId}}"]
            },
            "description": "Check the status of an OCR job. Poll this endpoint until status is 'completed' or 'failed'."
          },
          "response": []
        },
        {
          "name": "Parse Text (Async)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// This endpoint may still be synchronous",
                  "// Check if response has jobId (async) or parsed (sync)",
                  "const jsonData = pm.response.json();",
                  "",
                  "if (jsonData.jobId) {",
                  "    pm.test('Async mode - has jobId', function () {",
                  "        pm.expect(jsonData).to.have.property('jobId');",
                  "        pm.expect(jsonData).to.have.property('status');",
                  "        pm.collectionVariables.set('currentJobId', jsonData.jobId);",
                  "    });",
                  "} else {",
                  "    pm.test('Sync mode - has parsed result', function () {",
                  "        pm.expect(jsonData).to.have.property('parsed');",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"text\": \"Chocolate Chip Cookies\\n\\n2 cups flour\\n1 cup sugar\\n1 cup butter\\n2 eggs\\n1 tsp vanilla\\n2 cups chocolate chips\\n\\nMix dry ingredients. Add wet ingredients. Fold in chocolate chips. Bake at 350F for 12 minutes.\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/ocr/parse",
              "host": ["{{baseUrl}}"],
              "path": ["api", "ocr", "parse"]
            },
            "description": "Parse OCR text into recipe format. May be async or sync depending on configuration."
          },
          "response": []
        }
      ]
    },
    {
      "name": "OCR - Legacy Sync Flow",
      "item": [
        {
          "name": "Upload Image (Sync Fallback)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const jsonData = pm.response.json();",
                  "",
                  "// Check if sync or async response",
                  "if (jsonData.parsed) {",
                  "    pm.test('Sync mode - has parsed result', function () {",
                  "        pm.expect(jsonData).to.have.property('parsed');",
                  "        pm.expect(jsonData).to.have.property('text');",
                  "    });",
                  "} else if (jsonData.jobId) {",
                  "    pm.test('Async mode - has jobId', function () {",
                  "        pm.expect(jsonData).to.have.property('jobId');",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "image",
                  "type": "file",
                  "src": []
                }
              ]
            },
            "url": {
              "raw": "{{baseUrl}}/api/ocr/upload",
              "host": ["{{baseUrl}}"],
              "path": ["api", "ocr", "upload"]
            },
            "description": "Same endpoint as async, but will use sync processing if Pub/Sub is unavailable."
          },
          "response": []
        }
      ]
    },
    {
      "name": "Database Queries",
      "item": [
        {
          "name": "Get Job by ID (Manual)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/ocr/status/:jobId",
              "host": ["{{baseUrl}}"],
              "path": ["api", "ocr", "status", ":jobId"],
              "variable": [
                {
                  "key": "jobId",
                  "value": "paste-job-id-here"
                }
              ]
            },
            "description": "Manually check a specific job by pasting its UUID."
          },
          "response": []
        }
      ]
    },
    {
      "name": "Health & Monitoring",
      "item": [
        {
          "name": "Health Check",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('API is healthy', function () {",
                  "    pm.response.to.have.status(200);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/health",
              "host": ["{{baseUrl}}"],
              "path": ["health"]
            }
          },
          "response": []
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "https://souschef-api-238603140451.us-central1.run.app",
      "type": "string"
    },
    {
      "key": "localUrl",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "testEmail",
      "value": "test@lawrence.com",
      "type": "string"
    },
    {
      "key": "testPassword",
      "value": "testing123",
      "type": "string"
    },
    {
      "key": "accessToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "currentJobId",
      "value": "",
      "type": "string"
    }
  ]
}
