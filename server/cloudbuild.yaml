steps:
  # Debug step (list files first)
  - name: "alpine"
    id: "debug-list-files"
    args: ["sh", "-c", "ls -la /workspace"]

  # Precheck: Fail early if no Dockerfile exists
  - name: "alpine"
    id: "check-dockerfile"
    args:
      [
        "sh",
        "-c",
        "if [ ! -f Dockerfile ]; then echo 'âŒ Missing Dockerfile'; exit 1; fi",
      ]

  # 1. Build Docker image
  - name: "gcr.io/cloud-builders/docker"
    id: "docker-build"
    args: [
        "build",
        "--no-cache", # Force rebuild without cache
        "-t",
        "gcr.io/$PROJECT_ID/souschef-api",
        ".", # Context is current directory (server)
      ]

  # 2. Push Docker image to GCR
  - name: "gcr.io/cloud-builders/docker"
    id: "docker-push"
    args: ["push", "gcr.io/$PROJECT_ID/souschef-api"]

  # 3. Deploy to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-cloud-run"
    entrypoint: "gcloud"
    args:
      [
        "run",
        "deploy",
        "souschef-api",
        "--image",
        "gcr.io/$PROJECT_ID/souschef-api",
        "--region",
        "us-central1",
        "--platform",
        "managed",
        "--port",
        "8080",
        "--service-account",
        "souschef-api@$PROJECT_ID.iam.gserviceaccount.com",
        "--set-secrets",
        "API_KEY=API_KEY:latest,CLIENT_URL=CLIENT_URL:latest,CSRF_SECRET=CSRF_SECRET:latest,DB_ENCRYPTION_KEY=DB_ENCRYPTION_KEY:latest,GOOGLE_ACCESS_TOKEN_URL=GOOGLE_ACCESS_TOKEN_URL:latest,GOOGLE_CALLBACK_URL=GOOGLE_CALLBACK_URL:latest,GOOGLE_CLIENT_ID=GOOGLE_CLIENT_ID:latest,GOOGLE_CLIENT_SECRET=GOOGLE_CLIENT_SECRET:latest,GOOGLE_OAUTH_URL=GOOGLE_OAUTH_URL:latest,GOOGLE_TOKEN_INFO_URL=GOOGLE_TOKEN_INFO_URL:latest,JWT_ACCESS_EXPIRATION=JWT_ACCESS_EXPIRATION:latest,JWT_REFRESH_EXPIRATION=JWT_REFRESH_EXPIRATION:latest,JWT_SECRET=JWT_SECRET:latest,NODE_ENV=NODE_ENV:latest,PG_DATABASE=PG_DATABASE:latest,PG_HOST=PG_HOST:latest,PG_PASSWORD=PG_PASSWORD:latest,PG_PORT=PG_PORT:latest,PG_URL=PG_URL:latest,PG_USER=PG_USER:latest,RUN_MIGRATIONS=RUN_MIGRATIONS:latest,SESSION_SECRET=SESSION_SECRET:latest,VITE_API_URL=VITE_API_URL:latest",
        "--allow-unauthenticated",
      ]

    # 4. Wait for the expected routes to appear on the deployed service. This helps
    # catch issues where a revision starts but some routers or modules are not yet
    # imported (we poll the /debug/routes endpoint added to the app).
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "wait-for-routes"
    entrypoint: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        SERVICE_URL=$(gcloud run services describe souschef-api --region us-central1 --platform managed --format 'value(status.url)')
        echo "Waiting for expected routes at $${SERVICE_URL}/debug/routes"
        for i in $(seq 1 30); do
          echo "Attempt: ${i}"
          if curl -s --fail "$${SERVICE_URL}/debug/routes" | grep -q "/api/oauth/google/token"; then
            echo "Found oauth route - routes appear healthy"
            exit 0
          fi
          sleep 4
        done
        echo "Timed out waiting for oauth route to appear" >&2
        exit 1
images:
  - "gcr.io/$PROJECT_ID/souschef-api"

options:
  machineType: "E2_HIGHCPU_8"
  logging: CLOUD_LOGGING_ONLY
